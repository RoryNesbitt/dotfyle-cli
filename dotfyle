#!/usr/bin/env sh

dir_name="dotfyle"

is_ignored() {
  found=false
  case "$1" in
    *"." | *".." | *"*" | *".git")
      found=true
      return
      ;;
  esac
  $found
}

find_init() {
  if ls "$1"/init.lua 1> /dev/null 2>&1 \
  || ls "$1"/init.vim 1> /dev/null 2>&1; then
    path=${1#"$HOME/.config/$dir_name/"}
    echo "$path"
  else
    for x in "*" ".*"; do
      for pathname in "$1/"$x; do
        if is_ignored "$pathname"; then
          continue # skip these directories
        elif [ -d "$pathname" ]; then
          find_init "$pathname"
        fi
      done
    done
  fi
}

select_config() {
  find_init "$HOME/.config/$dir_name" | fzf --prompt="Config: " --preview="cat $HOME/.config/$dir_name/{}/init.*" --preview-window=right:70%:wrap --bind=ctrl-f:page-down,ctrl-b:page-up --height=100% --border
}

run() {
  case "$@" in
    "")
      #TODO: check last used config
      ;;
    "-a" | "--ask")
      shift
      ;;
    "-s"*| "--select"*)
      shift
      location="$HOME/.config/$dir_name/$1"
      if [ -f "$location/init.lua" ] || [ -f "location/init.vim" ]; then
        appname="$1"
      else
        echo config not found
        exit 1
      fi
      ;;
    *)
      echo Unknown option provided
      exit 1
      ;;
  esac
  if [ -z "$appname" ]; then
    appname="$(select_config)"
  fi
  if [ -n "$appname" ]; then
    NVIM_APPNAME="$dir_name/$appname" nvim
  fi
}

purge() {
  if [ "$1" = "-f" ] || [ "$1" = "--force" ]; then
    shift
  elif [ $# = 0 ]; then
    echo "purging without force sucks"
    exit
  fi
  rm -rf "$HOME/.config/$dir_name/$1"
  rm -rf "$HOME/.cache/$dir_name/$1"
  rm -rf "$HOME/.local/share/$dir_name/$1"
  rm -rf "$HOME/.local/state/$dir_name/$1"
}

remove() {
  appname="$(select_config)"
  if [ -n "$appname" ]; then
    purge "$appname"
  fi
}

case "$@" in
  *"-h" | *"--help" | "-h"* | "--help"*)
    help "$@"
    ;;
  "" | "-a" | "--ask" | "-s" | "--select")
    run "$@"
    ;;
  "run"*)
    shift
    run "$@"
    ;;
  "rm"*)
    shift
    remove "$@"
    ;;
  "purge"*)
    shift
    purge "$@"
    ;;
  *)
    echo Invalid option provided
    echo Exiting
    exit 1
    ;;
esac
